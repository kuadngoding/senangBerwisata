{% extends "base.html" %}
{% load static %}

{% block title %}Profile Pengguna - Senang Berwisata{% endblock %}

{% block hero_section %}{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        line-height: 1.6;
        background-color: var(--background-light);
    }

    .profile-header {
        background-color: var(--primary-blue);
        position: relative;
        height: 240px;
        margin-bottom: 80px;
        overflow: hidden;
    }

    .profile-header-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(to right, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 40%, rgba(0,0,0,0.1) 100%);
        z-index: 2;
    }

    .profile-header-bg {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.5;
        z-index: 1;
    }

    .profile-info {
        position: relative;
        z-index: 3;
        max-width: 1280px;
        margin: 0 auto;
        padding: 2rem 1.25rem;
        display: flex;
        align-items: flex-end;
        color: white;
    }

    .profile-avatar {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        border: 4px solid white;
        background-color: var(--secondary-blue-green);
        margin-bottom: -70px;
        position: relative;
        overflow: hidden;
    }

    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .profile-meta {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }

    .profile-section {
        background-color: white;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--separator-light);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-main);
    }

    .profile-points {
        font-weight: 600;
        color: var(--accent-blue);
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        display: inline-block;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background-color: var(--primary-blue);
        color: var(--text-white);
    }

    .btn-primary:hover {
        background-color: #2a7088;
    }

    .btn-success {
        background-color: var(--secondary-blue-green);
        color: var(--text-white);
    }

    .btn-success:hover {
        background-color: #4EC28D;
    }

    .btn-disabled {
        background-color: #e0e0e0;
        color: #9e9e9e;
        cursor: not-allowed;
    }

    .coupon-card {
        background-color: var(--background-light);
        border: 1px solid var(--separator-light);
        border-radius: 0.75rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: transform 0.2s ease;
    }

    .coupon-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    .coupon-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .coupon-code {
        font-family: 'Courier New', monospace;
        background-color: rgba(93, 211, 158, 0.1);
        color: var(--accent-blue);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 600;
    }

    .coupon-date {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .review-card {
        background-color: var(--background-light);
        border: 1px solid var(--separator-light);
        border-radius: 0.75rem;
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: all 0.2s ease;
    }

    .review-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .review-place {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .review-date {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .rating {
        color: #FFD700;
        font-size: 1.25rem;
        margin-bottom: 0.5rem;
    }

    .rating-empty {
        color: #e0e0e0;
    }

    .review-comment {
        color: var(--text-main);
        margin-top: 0.5rem;
    }

    .review-edited {
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-style: italic;
        margin-top: 0.5rem;
    }

    .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 1rem;
        margin: 1rem 0;
        height: 0.5rem;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--secondary-blue-green);
        border-radius: 1rem;
        transition: width 0.3s ease;
    }

    .empty-state {
        text-align: center;
        padding: 2rem 0;
        color: var(--text-secondary);
    }

    .container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 0 1.25rem;
    }

    .breadcrumb {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem 0;
    }

    .breadcrumb a {
        color: var(--text-secondary);
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .breadcrumb a:hover {
        color: var(--primary-blue);
    }

    .breadcrumb span {
        margin: 0 0.5rem;
        color: var(--text-secondary);
    }

    .breadcrumb .current {
        color: var(--text-main);
        font-weight: 500;
    }

    #couponModal {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        background-color: rgba(0,0,0,0.5);
        display: none;
    }

    #couponModal .modal-content {
        background-color: white;
        border-radius: 0.5rem;
        padding: 2rem;
        max-width: 24rem;
        width: 100%;
        text-align: center;
    }

    #couponModal .modal-icon {
        width: 64px;
        height: 64px;
        stroke: var(--secondary-blue-green);
        margin: 0 auto 1rem auto;
    }

    #couponModal .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    #couponModal .modal-subtitle {
        color: var(--text-secondary);
        margin-bottom: 1rem;
    }

    #couponModal .coupon-container {
        background-color: var(--background-light);
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
    }

    #couponModal .coupon-code-container {
        background-color: white;
        padding: 0.5rem;
        border-radius: 0.25rem;
        margin: 0.5rem 0;
    }

    #couponModal .coupon-code {
        font-family: 'Courier New', monospace;
        color: var(--accent-blue);
        font-size: 1.125rem;
    }

    #couponModal .modal-close-btn {
        background-color: var(--secondary-blue-green);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .profile-info {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .profile-avatar {
            margin-bottom: 1rem;
        }
        
        .profile-meta {
            margin-left: 0;
            margin-bottom: 2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Breadcrumb -->
    <div class="container">
        <div class="breadcrumb">
            <a href="/">Home</a>
            <span>/</span>
            <span class="current">Profile</span>
        </div>
    </div>

    <!-- Profile Header -->
    <header class="profile-header">
        <img src="{% static 'image/hero.jpg' %}" alt="Background" class="profile-header-bg">
        <div class="profile-header-overlay"></div>
        <div class="profile-info">
            <div class="profile-avatar">
                <img src="https://api.dicebear.com/6.x/initials/svg?seed={{ username }}" alt="{{ username }}">
            </div>
            <div class="profile-meta">
                <h2>{{ username }}</h2>
                <p>{{ email }}</p>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Traveller's Quest Recap Section -->
        <section class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Traveller's Quest Recap</h3>
                <p class="body-1">Let's collect the points to get a reward</p>
            </div>
            
            <button 
                id="redeemPointsBtn"
                class="btn {% if points >= 2000 %}btn-success{% else %}btn-disabled{% endif %}"
                {% if points < 2000 %}disabled{% endif %} 
                onclick="redeemCoupon()"
            >
                Tukar 2000 Poin untuk Kupon
            </button>
        </section>

        <!-- Bagian Riwayat Kupon -->
        <section class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Riwayat Kupon</h3>
            </div>
            
            <div id="coupons-container">
                {% if coupons %}
                    <div class="space-y-2">
                        {% for coupon in coupons %}
                        <div class="coupon-card">
                            <div class="coupon-header">
                                <div>
                                    <span class="subtitle-2">{{ coupon.get_brand_display }}</span>
                                    <span class="coupon-code">{{ coupon.code }}</span>
                                </div>
                                <span class="coupon-date">{{ coupon.created_at|date:"d M Y" }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div id="empty-state" class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem auto; color: #ccc; display: block;">
                            <rect x="3" y="5" width="18" height="14" rx="2" ry="2"></rect>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Belum ada riwayat kupon
                    </div>
                {% endif %}
            </div>
        </section>

        <!-- Traveller's Thematic Page Section -->
        <section class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Traveller's Thematic Page</h3>
                <p class="body-1">Tailored travel ideas, just the way you like them</p>
            </div>
            
            {% if user_thematic_routes %}
                <div style="display: flex; overflow-x: auto; padding-bottom: 1.5rem; gap: 1.25rem;" class="no-scrollbar">
                    {% for rute in user_thematic_routes %}
                        <div style="min-width: 280px; max-width: 280px; background-color: #f8f9fa; border-radius: 1rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: transform 0.3s ease, box-shadow 0.3s ease; cursor: pointer; flex-shrink: 0;" onclick="window.location='{% url 'detail_rute' rute.pk %}'">
                            <div style="position: relative; height: 180px; overflow: hidden;">
                                <img style="width: 100%; height: 100%; object-fit: cover;" src="{{ rute.gambar.url }}" alt="{{ rute.judul }}">
                            </div>
                            <div style="padding: 1.25rem;">
                                <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    <a href="{% url 'detail_rute' rute.pk %}" style="color: var(--text-main); text-decoration: none;">
                                        {{ rute.judul }}
                                    </a>
                                </h3>
                                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; height: 3.6em;">
                                    {{ rute.deskripsi|truncatechars:150 }}
                                </p>
                                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.75rem; font-style: italic;">
                                    By {{ rute.dibuat_oleh.username }} - {{ rute.tanggal_dibuat|date:"F d, Y" }}
                                </p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem auto; color: #ccc; display: block;">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    Belum ada rute tematik yang Anda buat.
                </div>
            {% endif %}
            
            <!-- Create New Route Button -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="{% url 'tambah_rute' %}" style="display: inline-flex; align-items: center; background-color: var(--accent-blue); color: white; padding: 0.75rem 1.5rem; border-radius: 2rem; text-decoration: none; font-weight: 500;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 0.5rem;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create your own page
                </a>
            </div>
        </section>

        <!-- Riwayat Review -->
        <section class="profile-section">
            <div class="section-header">
                <h3 class="section-title">Riwayat Review Anda</h3>
            </div>
            
            {% if reviews %}
                <div class="space-y-4">
                    {% for review in reviews %}
                    <div class="review-card">
                        <div class="review-header">
                            <div class="review-place">{{ review.place.name }}</div>
                            <div class="review-date">{{ review.created_at|date:"d M Y" }}</div>
                        </div>

                        <div class="rating">
                            {% for i in "12345" %}
                                {% if forloop.counter <= review.rating %}
                                    ★
                                {% else %}
                                    <span class="rating-empty">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <p class="review-comment">{{ review.comment }}</p>
                        
                        {% if review.updated_at and review.updated_at != review.created_at %}
                            <p class="review-edited">Diedit pada {{ review.updated_at|date:"d M Y" }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="margin: 0 auto 1rem auto; color: #ccc; display: block;">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                    Belum ada review yang Anda buat.
                </div>
            {% endif %}
        </section>
    </div>

    <!-- Coupon Modal -->
    <div id="couponModal" class="modal">
        <div class="modal-content">
            <div class="text-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="modal-icon">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                
                <h3 class="modal-title">Successful Redemption!</h3>
                <p class="modal-subtitle">You have successfully redeemed a coupon for:</p>
                
                <div class="coupon-container">
                    <h4 class="font-bold text-lg" id="modalTitle"></h4>
                    <div class="coupon-code-container">
                        <code class="coupon-code" id="modalCode"></code>
                    </div>
                </div>
                
                <button class="modal-close-btn" onclick="document.getElementById('couponModal').style.display='none'">
                    Close
                </button>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    function redeemCoupon() {
        fetch('/coupon/redeem/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw err });
            }
            return response.json();
        })
        .then(data => {
            if(data.success) {
                document.getElementById('profile-points').textContent = data.new_points;
                
                const redeemBtn = document.getElementById('redeemBtn');
                const redeemPointsBtn = document.getElementById('redeemPointsBtn');
                
                redeemBtn.disabled = data.new_points < 2000;
                redeemPointsBtn.disabled = data.new_points < 2000;
                
                if (data.new_points >= 2000) {
                    redeemBtn.classList.remove('btn-disabled');
                    redeemBtn.classList.add('btn-success');
                    redeemPointsBtn.classList.remove('btn-disabled');
                    redeemPointsBtn.classList.add('btn-success');
                } else {
                    redeemBtn.classList.remove('btn-success');
                    redeemBtn.classList.add('btn-disabled');
                    redeemPointsBtn.classList.remove('btn-success');
                    redeemPointsBtn.classList.add('btn-disabled');
                }
                
                document.getElementById('modalTitle').textContent = data.brand;
                document.getElementById('modalCode').textContent = data.code;
                document.getElementById('couponModal').style.display = 'flex';

                const couponsContainer = document.getElementById('coupons-container');
                const emptyState = document.getElementById('empty-state');

                const newCouponHTML = `
                    <div class="coupon-card">
                        <div class="coupon-header">
                            <div>
                                <span class="subtitle-2">${data.brand}</span>
                                <span class="coupon-code">${data.code}</span>
                            </div>
                            <span class="coupon-date">${new Date(data.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</span>
                        </div>
                    </div>
                `;

                if (emptyState) {
                    emptyState.remove();
                    couponsContainer.innerHTML = `
                        <div class="space-y-2">
                            ${newCouponHTML}
                        </div>
                    `;
                } else {
                    couponsContainer.querySelector('.space-y-2').insertAdjacentHTML('afterbegin', newCouponHTML);
                }                
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.error || 'Terjadi kesalahan saat menukar kupon');
        });
    }
</script>
{% endblock %}