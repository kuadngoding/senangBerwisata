<!-- templates/place_detail.html -->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>{{ place.name }} – Detail</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .star {
      cursor: pointer;
      font-size: 1.5rem;
      color: #d1d5db; /* gray-300 */
    }
    .star.selected {
      color: #facc15; /* yellow-400 */
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  {% include 'navbar.html' %}

  {% if user.is_authenticated %}
    <div class="container mx-auto px-4 mt-4">
      <p class="text-right text-sm font-medium">
        Poin Anda: <span id="page-points">{{ user.points }}</span>
      </p>
    </div>
  {% endif %}

  <div class="container mx-auto px-4 py-8">
    <a href="{% url 'place_list' %}" class="text-blue-600 hover:underline mb-6 inline-block">
      ← Kembali ke daftar
    </a>

    <h1 class="text-3xl font-bold mb-2">{{ place.name }}</h1>
    <p class="text-sm text-gray-600 mb-1">{{ place.address }}</p>
    <a href="{{ place.google_maps_link }}" target="_blank"
       class="text-green-600 text-sm hover:underline">Lihat di Google Maps</a>
    <p class="mt-4 text-gray-700">{{ place.description }}</p>

    <h2 class="text-2xl font-semibold mt-8 mb-4">Galeri Foto</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
      <img src="{{ place.photo_main.url }}" alt="Foto utama" class="rounded-lg shadow">
      {% if place.photo_1 %}
        <img src="{{ place.photo_1.url }}" alt="Foto 1" class="rounded-lg shadow">
      {% endif %}
      {% if place.photo_2 %}
        <img src="{{ place.photo_2.url }}" alt="Foto 2" class="rounded-lg shadow">
      {% endif %}
      {% if place.photo_3 %}
        <img src="{{ place.photo_3.url }}" alt="Foto 3" class="rounded-lg shadow">
      {% endif %}
    </div>

    <h2 class="text-2xl font-semibold mt-10 mb-4">Ulasan Pengunjung</h2>
    <div id="reviews" class="space-y-4 mb-6 text-sm text-gray-800">Memuat ulasan...</div>

    {% if user.is_authenticated %}
      <form id="review-form" class="bg-white p-4 rounded shadow-md space-y-4">
        {% csrf_token %}
        <div>
          <label class="block font-medium mb-1">Rating:</label>
          <div id="star-container" class="flex gap-1">
            {% for i in "12345" %}
              <span class="star" data-value="{{ forloop.counter }}">&#9733;</span>
            {% endfor %}
          </div>
          <input type="hidden" id="rating" value="0">
        </div>
        <div>
          <label for="comment" class="block font-medium">Komentar:</label>
          <textarea id="comment" rows="3"
                    class="mt-1 w-full border rounded px-2 py-1"
                    placeholder="Tulis ulasanmu..."></textarea>
        </div>
        <button type="submit"
                class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          Kirim Ulasan
        </button>
      </form>
    {% else %}
      <p class="text-gray-600">
        Silakan <a href="{% url 'login' %}" class="text-blue-600 underline">login</a>
        untuk memberi ulasan.
      </p>
    {% endif %}
  </div>

  <script>
    const reviewsContainer = document.getElementById("reviews");
    const placeId = "{{ place.id }}";
    const username = "{{ user.username }}";

    function fetchReviews() {
      fetch(`/reviews/place/${placeId}/`)
        .then(res => res.json())
        .then(data => {
          const reviews = data.reviews;
          reviewsContainer.innerHTML = "";

          if (reviews.length === 0) {
            reviewsContainer.innerHTML = "<p>Belum ada ulasan.</p>";
          } else {
            reviews.forEach(review => {
              const isOwner = review.user === username;
              const created = new Date(review.created_at).toLocaleDateString();
              const updated = review.updated_at ? new Date(review.updated_at).toLocaleDateString() : null;
              const stars = "⭐".repeat(review.rating);

              reviewsContainer.innerHTML += `
                <div class="bg-white p-4 rounded shadow-md">
                  <p class="font-semibold">${review.user}</p>
                  <p><span class="font-medium">Rating:</span> <span class="text-yellow-500">${stars}</span></p>
                  <p><span class="font-medium">Deskripsi:</span> ${review.comment}</p>
                  <p class="text-sm text-gray-500">
                    Dibuat: ${created}
                    ${updated ? `<br>Diperbarui: ${updated}` : ""}
                  </p>
                  ${isOwner ? `
                    <a href="/reviews/edit/${review.id}/" class="text-blue-600 text-sm mt-1 inline-block hover:underline">Edit</a>
                  ` : ""}
                </div>
              `;
            });
          }
        });
    }

    fetchReviews();

    // Star rating interaction
    const stars = document.querySelectorAll(".star");
    const ratingInput = document.getElementById("rating");

    stars.forEach(star => {
      star.addEventListener("click", () => {
        const value = parseInt(star.dataset.value);
        ratingInput.value = value;
        stars.forEach(s => s.classList.remove("selected"));
        for (let i = 0; i < value; i++) {
          stars[i].classList.add("selected");
        }
      });
    });

    const form = document.getElementById("review-form");
    if (form) {
      form.addEventListener("submit", function(e) {
        e.preventDefault();
        const rating = ratingInput.value;
        const comment = document.getElementById("comment").value;

        fetch(`/reviews/place/${placeId}/add/`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          },
          body: JSON.stringify({ rating, comment })
        })
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            return alert("Error: " + data.error);
          }

          form.reset();
          ratingInput.value = 0;
          stars.forEach(s => s.classList.remove("selected"));
          fetchReviews();

          const pagePoints = document.getElementById("page-points");
          if (pagePoints && data.points !== undefined) {
            pagePoints.textContent = data.points;
          }

          const navPoints = document.getElementById("nav-points");
          if (navPoints && data.points !== undefined) {
            navPoints.textContent = `Poin: ${data.points}`;
          }
        })
        .catch(console.error);
      });
    }
  </script>
</body>
</html>
